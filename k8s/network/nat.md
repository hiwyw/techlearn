# SNAT
- -A KUBE-SERVICES ! -s 10.42.0.0/16 -d 10.43.252.164/32 -p tcp -m comment --comment "default/myapp-cluster:http cluster IP" -m tcp --dport 8080 -j KUBE-MARK-MASQ
- -A KUBE-NODEPORTS -p tcp -m comment --comment "default/myapp-nodeport:http" -m tcp --dport 32567 -j KUBE-MARK-MASQ
- -A KUBE-SEP-7FEPB66XRJOPAWU2 -s 10.42.3.3/32 -j KUBE-MARK-MASQ
> - 非Pod网络访问ClusterIP类型服务全做SNAT，源地址会被重置为第一个接收到请求的Node的IP
> - NodePort类型服务全做SNAT，源地址会被重置为被访问的Node的IP
> - pod访问service如果被负载到自身，会做SNAT，源地址会被重置为pod所在NodeIP；如果负载到别的pod，不会做SNAT
# DNAT
- -A KUBE-SEP-7FEPB66XRJOPAWU2 -p tcp -m tcp -j DNAT --to-destination 10.42.3.3:80
> 所有访问service的都会被DNAT
# NAT演示
> - HeadLess类型：通过DNS直接解析为Pod的IP，不属于service网络，所以此处不演示
> - LoadBalancer类型：环境没有所以此处不演示
```                                        
node2(10.0.0.146)        ------------------>        node3(10.0.0.148)     ClusterIP:  10.43.252.164:8080
       |^         \                                /        |^            NodePort:   10.0.0.146:32567
       ||           \                            /          ||
       ||             \                        /            ||    
       v|               \                    /              v|
 pod1(10.42.2.5)         node1(10.0.0.145/117)         pod(10.42.3.3)
                                  /^                
                                 //                                         
                                //                                                                         
                               v/        
                   client(10.0.0.120)              
```

- 集群外client访问ClusterIP
> curl 10.43.252.164:8080/hostname.html
```
10.0.0.120:   10.0.0.120:39058 > 10.43.252.164:8080             10.43.252.164.8080 > 10.0.0.120.39058
                               |                                             ^
                               v                                             |
10.0.0.145:   10.0.0.120:39058 > 10.43.252.164:8080             10.43.252.164.8080 > 10.0.0.120.39058
                               | SNAT+DNAT                                   ^ 根据conntrack记录逆向操作
                               v                                             |
10.0.0.148:   10.0.0.145:39058 > 10.42.3.3:80                   10.42.3.3:80 > 10.0.0.145:39058
                               |                                             ^
                               v                                             |
10.42.3.3:    10.0.0.145:39058 > 10.42.3.3:80        ----->     10.42.3.3:80 > 10.0.0.145:39058

```
- 集群外client访问NodePort
> curl 10.0.0.146:32567/hostname.html
```
10.0.0.146    10.0.0.120.34510 > 10.0.0.146.32567               10.0.0.146.32567 > 10.0.0.120.34510
                               | SNAT+DNAT                                   ^ 根据conntrack记录逆向操作
                               v                                             |
10.0.0.148    10.0.0.146.34510 > 10.42.3.3.80                   10.42.3.3.80 > 10.0.0.146.34510
                               |                                             ^
                               v                                             |
10.42.3.3     10.0.0.146.34510 > 10.42.3.3.80        ----->     10.42.3.3.80 > 10.0.0.146.34510

```
- 集群内node1访问ClusterIP
> telnet -b 10.0.0.117 10.43.252.164 8080
```
10.0.0.145    10.0.0.117:50421 > 10.43.252.164:8080             10.43.252.164:8080 > 10.0.0.117:50421
                               | SNAT+DNAT                                   ^ 根据conntrack记录逆向操作
                               v                                             |
10.0.0.148    10.0.0.145.50421 > 10.42.3.3.80                   10.42.3.3.80 > 10.0.0.145.50421
                               |                                             ^
                               v                                             |
10.42.3.3     10.0.0.145.50421 > 10.42.3.3.80        ----->     10.42.3.3.80 > 10.0.0.145.50421

```
- 集群内node1访问NodePort
> curl 10.0.0.146:32567/hostname.html
```
10.0.0.146    10.0.0.145.48150 > 10.0.0.146.32567               10.0.0.146.32567 > 10.0.0.145.48150
                             | SNAT+DNAT                                     ^ 根据conntrack记录逆向操作
                             v                                               |
10.0.0.148    10.0.0.146.48150 > 10.42.3.3.80                   10.42.3.3.80 > 10.0.0.146.48150
                             |                                               ^
                             v                                               |
10.42.3.3     10.0.0.146.48150 > 10.42.3.3.80        ----->     10.42.3.3.80 > 10.0.0.146.48150
```
- 集群内pod1访问ClusterIP
> curl 10.43.252.164:8080/hostname.html
```
10.0.0.146    10.42.2.5.60130 > 10.42.3.3.80                    10.42.3.3.80 > 10.42.2.5.60130
                             | DNAT                                         ^ 根据conntrack记录逆向操作
                             v                                              |
10.0.0.148    10.42.2.5.60130 > 10.42.3.3.80                    10.42.3.3.80 > 10.42.2.5.60130
                             |                                              ^
                             v                                              |
10.42.3.3     10.42.2.5.60130 > 10.42.3.3.80        ----->      10.42.3.3.80 > 10.42.2.5.60130
```
- 集群内pod1访问NodePort
> curl 10.0.0.145:32567/hostname.html
```
10.0.0.146     10.0.0.146.33320 > 10.0.0.145.32567              10.0.0.145.32567 > 10.0.0.146.33320
                             |                                               ^
                             v                                               |
10.0.0.145     10.0.0.146.33320 > 10.0.0.145.32567              10.0.0.145.32567 > 10.0.0.146.33320
                             | SNAT+DNAT                                     ^ 根据conntrack记录逆向操作
                             v                                               |
10.0.0.148     10.0.0.145.33320 > 10.42.3.3.80                  10.42.3.3.80 > 10.0.0.145.33320
                             |                                               ^
                             v                                               |
10.42.3.3     10.0.0.145.33320 > 10.42.3.3.80        ----->     10.42.3.3.80 > 10.0.0.145.33320
```
